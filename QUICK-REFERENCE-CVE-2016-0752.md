# Quick Reference Guide: CVE-2016-0752 Mitigation

## Overview
This guide provides quick reference for implementing the fix for CVE-2016-0752 directory traversal vulnerability in Ruby on Rails applications.

## Quick Fix Checklist

### 1. Identify Vulnerable Code
Search your codebase for these patterns:
```bash
grep -r "render.*params\[" app/controllers/
grep -r "render.*file:" app/controllers/
grep -r "render.*template:" app/controllers/
grep -r "render.*partial:" app/controllers/
```

### 2. Update Rails Version
```bash
# Check current version
rails --version

# Update to patched version
# In Gemfile:
gem 'rails', '>= 4.2.5.1'  # or later

# Then run:
bundle update rails
```

### 3. Implement Input Validation

#### Option A: Whitelist Approach (Recommended)
```ruby
ALLOWED_TEMPLATES = ['welcome', 'about', 'contact'].freeze

def show
  template = params[:template]
  
  unless ALLOWED_TEMPLATES.include?(template)
    render plain: "Unauthorized", status: :forbidden
    return
  end
  
  render template: template
end
```

#### Option B: Path Sanitization
```ruby
def sanitize_path(path)
  return '' if path.nil?
  
  sanitized = path.to_s
  # Remove directory traversal sequences
  sanitized = sanitized.gsub(/\.\.\//, '').gsub(/\.\.\\/, '')
  # Remove leading slashes
  sanitized = sanitized.gsub(/^\/+/, '')
  # Remove null bytes
  sanitized = sanitized.gsub(/\x00/, '')
  
  sanitized
end

def show
  template = sanitize_path(params[:template])
  
  # Additional validation
  if template.include?('..') || template.include?('/')
    render plain: "Invalid input", status: :bad_request
    return
  end
  
  render template: template
end
```

#### Option C: Canonical Path Validation
```ruby
def show
  template = params[:template]
  base_path = Rails.root.join('app', 'views', 'pages')
  full_path = base_path.join(sanitize_path(template))
  
  # Verify path is within base directory
  unless full_path.to_s.start_with?(base_path.to_s)
    render plain: "Access denied", status: :forbidden
    return
  end
  
  render file: full_path.to_s
end
```

### 4. Add Route Constraints
```ruby
# config/routes.rb
constraints(template: /[a-zA-Z0-9_-]+/) do
  get 'pages/:template', to: 'pages#show'
end
```

### 5. Enable Security Logging
```ruby
def show
  template = params[:template]
  
  if template.include?('..') || template.include?('/')
    Rails.logger.warn(
      "Path traversal attempt: IP=#{request.remote_ip} " \
      "Template=#{template} Time=#{Time.now}"
    )
    # Send alert to security team
  end
  
  # ... rest of the code
end
```

### 6. Add Security Tests
```ruby
# spec/controllers/pages_controller_spec.rb
RSpec.describe PagesController, type: :controller do
  describe 'GET #show' do
    it 'prevents directory traversal' do
      get :show, params: { template: '../../../../etc/passwd' }
      expect(response).to have_http_status(:forbidden)
    end
    
    it 'allows valid templates' do
      get :show, params: { template: 'welcome' }
      expect(response).to have_http_status(:success)
    end
  end
end
```

## Testing the Fix

### Manual Testing
```bash
# Test 1: Basic traversal
curl "http://localhost:3000/pages/../../../../etc/passwd"

# Test 2: URL encoded
curl "http://localhost:3000/pages/%2e%2e%2f%2e%2e%2fetc%2fpasswd"

# Test 3: Valid input
curl "http://localhost:3000/pages/welcome"
```

### Automated Testing
```bash
# Install Brakeman
gem install brakeman

# Run security scan
brakeman -A -q

# Run tests
rspec spec/controllers/
```

## Common Pitfalls to Avoid

### ❌ DON'T: Use blacklisting
```ruby
# Bad - easy to bypass
def show
  template = params[:template]
  if template.include?('..')
    # Attacker can use URL encoding
    return
  end
  render template: template
end
```

### ❌ DON'T: Only check for "../"
```ruby
# Bad - doesn't handle all cases
def show
  template = params[:template]
  return if template.include?('../')
  # Doesn't handle "..\", absolute paths, etc.
  render template: template
end
```

### ❌ DON'T: Trust sanitized input without additional validation
```ruby
# Insufficient
def show
  template = sanitize_path(params[:template])
  # Should also validate it's in whitelist or base directory
  render template: template
end
```

### ✅ DO: Use multiple layers of defense
```ruby
# Good - defense in depth
def show
  template = params[:template]
  
  # Layer 1: Whitelist
  return unless ALLOWED_TEMPLATES.include?(template)
  
  # Layer 2: Sanitization
  template = sanitize_path(template)
  
  # Layer 3: Validation
  return if template.include?('..') || template.include?('/')
  
  # Layer 4: Logging
  Rails.logger.info("Rendering template: #{template}")
  
  render template: template
end
```

## Implementation Priority

1. **Critical (Do Immediately)**
   - Update Rails to patched version
   - Implement whitelist validation for all render calls with user input
   - Add security logging

2. **High Priority (Within 1 Week)**
   - Add comprehensive tests
   - Implement path sanitization
   - Set up route constraints
   - Configure security headers

3. **Medium Priority (Within 1 Month)**
   - Security audit of entire codebase
   - Implement monitoring and alerting
   - Document allowed templates
   - Train development team

## Verification Steps

- [ ] Rails updated to >= 4.2.5.1
- [ ] All render calls with user input use whitelist validation
- [ ] Path sanitization implemented
- [ ] Security tests passing
- [ ] Route constraints configured
- [ ] Security logging enabled
- [ ] No Brakeman warnings
- [ ] Manual testing completed
- [ ] Code review completed
- [ ] Security team notified

## Support Resources

- **Full Documentation**: `CVE-2016-0752-DOCUMENTATION.md`
- **Example Code**: `rails-directory-traversal-cve-2016-0752.rb`
- **Test Suite**: `rails-directory-traversal-cve-2016-0752_spec.rb`
- **CVE Details**: https://nvd.nist.gov/vuln/detail/CVE-2016-0752
- **Rails Security Guide**: https://guides.rubyonrails.org/security.html

## Emergency Contacts

If you discover an active exploit:
1. Disable affected endpoints immediately
2. Notify security team
3. Check logs for suspicious activity
4. Review recent deployments
5. Implement hotfix ASAP

---

**Last Updated**: 2025-10-16
**Version**: 1.0
