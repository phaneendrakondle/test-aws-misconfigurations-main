#!/bin/bash

# Script to check for CVE-2016-0752 vulnerability
# This script checks if the vulnerable Action View version is present

set -e

echo "=================================================="
echo "CVE-2016-0752 Vulnerability Checker"
echo "Directory Traversal in Action View"
echo "=================================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Ruby is installed
if ! command -v ruby &> /dev/null; then
    echo -e "${RED}❌ Ruby is not installed${NC}"
    echo "Please install Ruby to check for this vulnerability"
    exit 1
fi

echo -e "${GREEN}✓ Ruby found:${NC} $(ruby --version)"
echo ""

# Check if Gemfile exists
if [ ! -f "Gemfile" ]; then
    echo -e "${YELLOW}⚠️  No Gemfile found in current directory${NC}"
    echo "This vulnerability affects Ruby on Rails applications"
    exit 0
fi

echo -e "${GREEN}✓ Gemfile found${NC}"
echo ""

# Check for Rails version in Gemfile
echo "Checking Gemfile for vulnerable Rails versions..."
echo ""

if grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.5['\"]" Gemfile || \
   grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.4['\"]" Gemfile || \
   grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.3['\"]" Gemfile || \
   grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.2['\"]" Gemfile || \
   grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.1['\"]" Gemfile || \
   grep -q "gem ['\"]rails['\"],.*['\"]4\.2\.0['\"]" Gemfile; then
    echo -e "${RED}❌ VULNERABLE: Rails 4.2.x version < 4.2.5.1 detected${NC}"
    VULNERABLE=true
fi

if grep -q "gem ['\"]rails['\"],.*['\"]4\.1\." Gemfile; then
    if ! grep -q "gem ['\"]rails['\"],.*['\"]4\.1\.14\.1" Gemfile && \
       ! grep -q "gem ['\"]rails['\"],.*['\"]4\.1\.1[5-9]" Gemfile; then
        echo -e "${RED}❌ VULNERABLE: Rails 4.1.x version < 4.1.14.1 detected${NC}"
        VULNERABLE=true
    fi
fi

if grep -q "gem ['\"]rails['\"],.*['\"]3\." Gemfile; then
    if ! grep -q "gem ['\"]rails['\"],.*['\"]3\.2\.22\.1" Gemfile && \
       ! grep -q "gem ['\"]rails['\"],.*['\"]3\.2\.2[3-9]" Gemfile; then
        echo -e "${RED}❌ VULNERABLE: Rails 3.x version < 3.2.22.1 detected${NC}"
        VULNERABLE=true
    fi
fi

# Check for actionview gem specifically
if grep -q "gem ['\"]actionview['\"],.*['\"]4\.2\.5['\"]" Gemfile || \
   grep -q "gem ['\"]actionview['\"],.*['\"]4\.2\.[0-4]['\"]" Gemfile; then
    echo -e "${RED}❌ VULNERABLE: Action View 4.2.x version < 4.2.5.1 detected${NC}"
    VULNERABLE=true
fi

if [ "$VULNERABLE" = true ]; then
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}          VULNERABILITY DETECTED!              ${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "CVE-2016-0752: Directory Traversal in Action View"
    echo "Severity: HIGH (CVSS 7.5)"
    echo ""
    echo "Description:"
    echo "A directory traversal vulnerability in Action View allows"
    echo "remote attackers to read arbitrary files by exploiting"
    echo "an application's unrestricted use of the render method."
    echo ""
    echo "Affected versions:"
    echo "  - Rails < 3.2.22.1"
    echo "  - Rails 4.0.x and 4.1.x < 4.1.14.1"
    echo "  - Rails 4.2.x < 4.2.5.1"
    echo ""
    echo -e "${YELLOW}Recommended Actions:${NC}"
    echo "1. Update Rails to a patched version:"
    echo "   - Rails 4.2.x: Update to >= 4.2.5.1"
    echo "   - Rails 4.1.x: Update to >= 4.1.14.1"
    echo "   - Rails 3.2.x: Update to >= 3.2.22.1"
    echo "   - Or update to Rails 5.x, 6.x, or 7.x (recommended)"
    echo ""
    echo "2. Never pass user input directly to render methods"
    echo ""
    echo "3. Use whitelisting for allowed templates"
    echo ""
    echo "For detailed mitigation steps, see CVE-2016-0752-README.md"
    echo ""
else
    echo -e "${GREEN}✓ No vulnerable Rails versions detected in Gemfile${NC}"
fi

# Check if bundler is available
if command -v bundle &> /dev/null; then
    echo ""
    echo "Checking if bundler-audit is available..."
    if command -v bundle-audit &> /dev/null || bundle exec bundle-audit --help &> /dev/null; then
        echo ""
        echo "Running bundler-audit for comprehensive check..."
        echo ""
        bundle audit check || true
    else
        echo ""
        echo -e "${YELLOW}⚠️  bundler-audit not installed${NC}"
        echo "For more comprehensive vulnerability scanning, install bundler-audit:"
        echo "  gem install bundler-audit"
        echo "Then run:"
        echo "  bundle audit check"
    fi
else
    echo ""
    echo -e "${YELLOW}⚠️  Bundler not installed${NC}"
    echo "To perform a comprehensive vulnerability check, install bundler:"
    echo "  gem install bundler"
    echo "  gem install bundler-audit"
    echo "  bundle install"
    echo "  bundle audit check"
fi

echo ""
echo "=================================================="
echo "Vulnerability check complete"
echo "=================================================="

# Exit with error code if vulnerable
if [ "$VULNERABLE" = true ]; then
    exit 1
else
    exit 0
fi
