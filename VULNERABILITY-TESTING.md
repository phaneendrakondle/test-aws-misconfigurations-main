# Testing CVE-2016-0752 Vulnerability

This guide explains how to test and detect the CVE-2016-0752 directory traversal vulnerability in Action View.

## Prerequisites

Before testing, ensure you have the following installed:

```bash
# Ruby (version 2.2 or later recommended for Rails 4.2.5)
ruby --version

# Bundler
gem install bundler

# Bundler Audit (for vulnerability scanning)
gem install bundler-audit
```

## Setting Up the Vulnerable Environment

1. **Navigate to the repository directory:**
   ```bash
   cd /path/to/test-aws-misconfigurations-main
   ```

2. **Install the vulnerable dependencies:**
   ```bash
   bundle install
   ```
   
   This will install Rails 4.2.5 with the vulnerable Action View component.

## Detecting the Vulnerability

### Method 1: Using Bundler Audit

Bundler Audit is a tool that checks your Gemfile.lock for known vulnerabilities:

```bash
# Update the vulnerability database
bundle audit update

# Check for vulnerabilities
bundle audit check
```

**Expected Output:**
```
Name: actionview
Version: 4.2.5
Advisory: CVE-2016-0752
Criticality: High
URL: https://groups.google.com/forum/#!topic/rubyonrails-security/335P1DcLG00
Title: Possible Information Leak Vulnerability in Action View

Vulnerabilities found!
```

### Method 2: Using Brakeman

Brakeman is a static analysis security scanner for Rails applications:

```bash
# Install Brakeman
gem install brakeman

# Run security scan
brakeman --path . --format plain
```

### Method 3: Using Snyk

Snyk can detect vulnerabilities in dependencies:

```bash
# Install Snyk CLI
npm install -g snyk

# Authenticate with Snyk
snyk auth

# Test for vulnerabilities
snyk test --file=Gemfile
```

### Method 4: Manual Version Check

Check the installed version of Action View:

```bash
bundle show actionview
```

If the version is 4.2.5 or any other vulnerable version, the vulnerability exists.

## Exploiting the Vulnerability (Testing Only)

⚠️ **WARNING:** Only test this in a controlled environment that you own!

### Setup a Test Rails Application

1. Create a new Rails app with the vulnerable version:
   ```bash
   # Use the vulnerable Gemfile in this repo
   rails new test_app --skip-bundle
   cd test_app
   cp /path/to/vulnerable/Gemfile .
   bundle install
   ```

2. Create a vulnerable controller:
   ```bash
   rails generate controller Vulnerable show
   ```

3. Add vulnerable code to `app/controllers/vulnerable_controller.rb`:
   ```ruby
   class VulnerableController < ApplicationController
     def show
       render params[:template]
     end
   end
   ```

4. Start the Rails server:
   ```bash
   rails server
   ```

5. Test the vulnerability:
   ```bash
   # Try to read /etc/passwd
   curl "http://localhost:3000/vulnerable/show?template=../../../../etc/passwd"
   
   # Try to read config/database.yml
   curl "http://localhost:3000/vulnerable/show?template=../../../../config/database"
   ```

If you can see the contents of system files or application configuration, the vulnerability is confirmed.

## Fixing the Vulnerability

### Solution 1: Update Rails to a Patched Version

Update your `Gemfile`:

```ruby
# From vulnerable version
gem 'rails', '4.2.5'

# To patched version (choose one)
gem 'rails', '~> 4.2.11.3'  # Latest 4.2.x
gem 'rails', '~> 5.2.8.1'   # Latest 5.2.x
gem 'rails', '~> 6.1.7.3'   # Latest 6.1.x
gem 'rails', '~> 7.0.8'     # Latest 7.0.x
gem 'rails', '~> 7.1.3'     # Latest stable
```

Then run:
```bash
bundle update rails
```

### Solution 2: Input Validation

Never pass user input directly to render methods. Use whitelisting:

```ruby
# Secure implementation
class SecureController < ApplicationController
  ALLOWED_TEMPLATES = {
    'home' => 'pages/home',
    'about' => 'pages/about',
    'contact' => 'pages/contact'
  }.freeze

  def show
    template_key = params[:template]
    
    if ALLOWED_TEMPLATES.key?(template_key)
      render ALLOWED_TEMPLATES[template_key]
    else
      head :not_found
    end
  end
end
```

### Solution 3: Use Action-Based Routing

Instead of dynamic template rendering, use proper Rails routing:

```ruby
# routes.rb
get '/pages/home', to: 'pages#home'
get '/pages/about', to: 'pages#about'
get '/pages/contact', to: 'pages#contact'

# pages_controller.rb
class PagesController < ApplicationController
  def home
    render :home
  end
  
  def about
    render :about
  end
  
  def contact
    render :contact
  end
end
```

## Verifying the Fix

After applying the fix:

1. **Re-run Bundler Audit:**
   ```bash
   bundle audit check
   ```
   
   Expected output: No vulnerabilities found!

2. **Test exploitation attempts:**
   ```bash
   curl "http://localhost:3000/vulnerable/show?template=../../../../etc/passwd"
   ```
   
   Should return: 404 Not Found or 400 Bad Request

3. **Check gem versions:**
   ```bash
   bundle show actionview
   ```
   
   Should show a patched version (>= 4.2.5.1, >= 4.1.14.1, or >= 3.2.22.1)

## Continuous Monitoring

### GitHub Dependabot

Enable Dependabot in your GitHub repository to automatically check for vulnerable dependencies:

1. Go to repository Settings
2. Navigate to Security & analysis
3. Enable Dependabot alerts
4. Enable Dependabot security updates

### CI/CD Integration

Add vulnerability scanning to your CI/CD pipeline:

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
      - name: Install dependencies
        run: |
          gem install bundler
          bundle install
      - name: Run Bundler Audit
        run: |
          gem install bundler-audit
          bundle audit update
          bundle audit check
```

## References

- [CVE-2016-0752 Details](https://nvd.nist.gov/vuln/detail/CVE-2016-0752)
- [Rails Security Announcement](https://groups.google.com/g/rubyonrails-security/c/335P1DcLG00)
- [Bundler Audit Documentation](https://github.com/rubysec/bundler-audit)
- [Brakeman Documentation](https://brakemanscanner.org/)
- [Rails Security Guide](https://guides.rubyonrails.org/security.html)

## Cleanup

After testing, remember to destroy any test applications and resources:

```bash
# Stop the Rails server (Ctrl+C)

# Remove test application
rm -rf test_app

# Optionally, revert to secure Gemfile
# Edit Gemfile and update Rails version
bundle update rails
```

## Disclaimer

This testing guide is for educational and security testing purposes only. Always:
- Test only in environments you own or have explicit permission to test
- Never test vulnerabilities against production systems
- Follow responsible disclosure practices
- Comply with all applicable laws and regulations
