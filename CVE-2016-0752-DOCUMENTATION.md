# CVE-2016-0752: Directory Traversal Vulnerability in Action View

## Overview

**CVE ID**: CVE-2016-0752  
**Severity**: HIGH (CVSS Score: 7.5)  
**Vulnerability Type**: Directory Traversal / Path Traversal  
**Affected Component**: Action View (Ruby on Rails)  
**Published**: 2016-01-25

## Description

A directory traversal vulnerability exists in Action View, a component of Ruby on Rails. This vulnerability allows remote attackers to read arbitrary files on the server by exploiting an application's unrestricted use of the `render` method with user-controlled input.

### How It Works

The vulnerability occurs when a Rails application:
1. Accepts user input (e.g., from URL parameters or form data)
2. Passes this input directly to the `render` method without validation
3. Allows path traversal sequences like `../` to navigate the file system

### Attack Example

```ruby
# Vulnerable controller code
def show
  template_name = params[:template]
  render template: template_name  # VULNERABLE!
end
```

An attacker can exploit this by sending:
```
GET /show?template=../../../../etc/passwd
```

This allows the attacker to:
- Read sensitive system files (e.g., `/etc/passwd`, `/etc/shadow`)
- Access application configuration files with credentials
- Read source code and business logic
- Discover other vulnerabilities

## Affected Versions

- Ruby on Rails 3.x before 3.2.22.1
- Ruby on Rails 4.x before 4.1.14.1
- Ruby on Rails 4.2.x before 4.2.5.1

## Technical Details

### Vulnerable Code Patterns

```ruby
# Pattern 1: Direct template rendering
render template: params[:template]

# Pattern 2: File rendering
render file: params[:file]

# Pattern 3: Partial rendering
render partial: params[:name]

# Pattern 4: Dynamic template selection
template = "templates/#{params[:view]}"
render template: template
```

### Attack Vectors

1. **URL Encoded Traversal**: `%2e%2e%2f` (encodes `../`)
2. **Double Encoded**: `%252e%252e%252f`
3. **Windows Path**: `..\..\..\windows\system32`
4. **Mixed Separators**: `..\../..\../etc/passwd`
5. **Null Byte Injection**: `file%00.txt` (bypasses extension checks)
6. **Absolute Paths**: `/etc/passwd`

## Security Impact

| Impact Area | Severity | Description |
|------------|----------|-------------|
| Confidentiality | HIGH | Attackers can read sensitive files |
| Integrity | LOW | Direct file modification not possible |
| Availability | LOW | Could lead to DoS if critical files accessed |
| Authentication | MEDIUM | Can read credential files |
| Authorization | HIGH | Bypasses file access controls |

## Mitigation Strategies

### 1. Whitelist Approach (Recommended)

```ruby
ALLOWED_TEMPLATES = ['welcome', 'about', 'contact'].freeze

def show
  template = params[:template]
  
  unless ALLOWED_TEMPLATES.include?(template)
    render plain: "Unauthorized", status: :forbidden
    return
  end
  
  render template: template
end
```

### 2. Path Sanitization

```ruby
def sanitize_path(path)
  # Remove directory traversal sequences
  sanitized = path.to_s.gsub(/\.\.\//, '').gsub(/\.\.\\/, '')
  
  # Remove leading slashes
  sanitized = sanitized.gsub(/^\/+/, '')
  
  # Remove null bytes
  sanitized = sanitized.gsub(/\x00/, '')
  
  sanitized
end
```

### 3. Canonical Path Validation

```ruby
def render_file_secure
  file_path = params[:file]
  base_path = Rails.root.join('app', 'views', 'public')
  full_path = base_path.join(sanitize_path(file_path))
  
  # Verify the resolved path is within the base directory
  unless full_path.to_s.start_with?(base_path.to_s)
    render plain: "Access denied", status: :forbidden
    return
  end
  
  render file: full_path.to_s
end
```

### 4. Route Constraints

```ruby
# config/routes.rb
constraints(template: /[a-zA-Z0-9_-]+/) do
  get 'show/:template', to: 'pages#show'
end
```

### 5. Strong Parameters

```ruby
class PagesController < ApplicationController
  def show
    # Only permit safe values
    allowed_params = params.permit(:id)
    
    # Use predefined mapping
    template = TEMPLATE_MAP[allowed_params[:id]]
    
    render template: template if template
  end
end
```

## Remediation Steps

### Step 1: Update Rails

```bash
# Check your Rails version
rails --version

# Update to patched version
gem update rails

# Or specify in Gemfile:
gem 'rails', '>= 4.2.5.1'
```

### Step 2: Audit Code

Search for vulnerable patterns:

```bash
# Find render calls with dynamic input
grep -r "render.*params\[" app/controllers/

# Find file operations
grep -r "render.*file:" app/controllers/

# Find template operations
grep -r "render.*template:" app/controllers/
```

### Step 3: Implement Input Validation

For each occurrence:
1. Identify the source of the input
2. Implement whitelist validation
3. Sanitize the input
4. Verify the path stays within allowed directories
5. Add logging for suspicious attempts

### Step 4: Add Security Tests

```ruby
# spec/controllers/pages_controller_spec.rb
RSpec.describe PagesController, type: :controller do
  describe 'GET #show' do
    it 'prevents directory traversal' do
      get :show, params: { template: '../../../etc/passwd' }
      expect(response).to have_http_status(:forbidden)
    end
    
    it 'blocks encoded traversal' do
      get :show, params: { template: '%2e%2e%2f%2e%2e%2fetc%2fpasswd' }
      expect(response).to have_http_status(:forbidden)
    end
    
    it 'allows valid templates' do
      get :show, params: { template: 'welcome' }
      expect(response).to have_http_status(:success)
    end
  end
end
```

## Testing for Vulnerability

### Manual Testing

```bash
# Test 1: Basic traversal
curl "http://localhost:3000/show?template=../../../../etc/passwd"

# Test 2: URL encoded
curl "http://localhost:3000/show?template=%2e%2e%2f%2e%2e%2fetc%2fpasswd"

# Test 3: Windows paths
curl "http://localhost:3000/show?file=..\\..\\..\\windows\\system32\\config\\sam"

# Test 4: Absolute path
curl "http://localhost:3000/show?file=/etc/passwd"

# Test 5: Null byte
curl "http://localhost:3000/show?file=../../../../etc/passwd%00.html"
```

### Automated Testing Tools

```bash
# Using OWASP ZAP
zap-cli quick-scan --self-contained http://localhost:3000

# Using Burp Suite
# Configure proxy and use active scanner

# Using Brakeman (Rails security scanner)
gem install brakeman
brakeman -A -q

# Using bundler-audit
gem install bundler-audit
bundle audit check --update
```

## Prevention Best Practices

### 1. Never Trust User Input

Always validate and sanitize user input before using it in file operations.

### 2. Use Whitelists, Not Blacklists

Define what IS allowed, not what ISN'T allowed.

### 3. Principle of Least Privilege

Run your application with minimal file system permissions.

### 4. Defense in Depth

Implement multiple layers of security:
- Input validation
- Path canonicalization
- Chroot jails or containers
- File system permissions
- Web Application Firewall (WAF)

### 5. Regular Security Audits

- Keep Rails and dependencies updated
- Use automated security scanning tools
- Conduct manual code reviews
- Perform penetration testing

### 6. Logging and Monitoring

```ruby
# Log suspicious access attempts
def show
  template = params[:template]
  
  if template.include?('..') || template.include?('/')
    Rails.logger.warn("Path traversal attempt: #{request.remote_ip} - #{template}")
    # Alert security team
  end
end
```

### 7. Content Security Policy

```ruby
# config/initializers/content_security_policy.rb
Rails.application.config.content_security_policy do |policy|
  policy.default_src :self, :https
  policy.script_src  :self, :https
  policy.style_src   :self, :https
end
```

## References

- [CVE-2016-0752](https://nvd.nist.gov/vuln/detail/CVE-2016-0752)
- [Rails Security Guide](https://guides.rubyonrails.org/security.html)
- [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)
- [Rails Advisory](https://groups.google.com/g/rubyonrails-security/c/335P1DcLG00)

## Related Vulnerabilities

- **CVE-2016-0751**: Action Pack denial of service
- **CVE-2015-7576**: Action View timing attack
- **CVE-2016-2097**: Action View XSS vulnerability
- **CVE-2019-5418**: File Content Disclosure (similar issue)

## Checklist for Developers

- [ ] Updated Rails to patched version (>= 4.2.5.1)
- [ ] Audited all `render` calls in controllers
- [ ] Implemented whitelist validation for dynamic templates
- [ ] Added path sanitization functions
- [ ] Verified paths stay within allowed directories
- [ ] Added security tests for path traversal
- [ ] Configured route constraints
- [ ] Enabled security logging
- [ ] Set up monitoring and alerting
- [ ] Documented allowed templates/files
- [ ] Conducted security review
- [ ] Ran automated security scanners
- [ ] Updated deployment documentation

## Support and Questions

For questions about implementing these fixes:
- Review the example code in `rails-directory-traversal-cve-2016-0752.rb`
- Consult the Rails Security Guide
- Engage with the Rails security community

---

**⚠️ IMPORTANT**: This documentation is for educational and security testing purposes. Always test security fixes in a development environment before deploying to production.
